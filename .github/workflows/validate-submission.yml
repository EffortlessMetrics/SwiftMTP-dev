name: Validate Device Submission

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'Contrib/submissions/**'
      - 'Specs/submission.schema.json'
      - 'scripts/validate-submission.sh'
      - 'scripts/validate-quirks.sh'

jobs:
  validate:
    runs-on: macos-latest
    name: Validate Device Submission

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install tooling
        run: |
          brew install jq || true
          python3 -m pip install --upgrade pip jsonschema || true
          npm -g install ajv-cli || true

      - name: Find submission bundles
        id: find-bundles
        run: |
          # Find all submission directories modified in this PR
          SUBMISSION_DIRS=$(find Contrib/submissions -name "submission.json" -exec dirname {} \; 2>/dev/null || true)

          if [ -z "$SUBMISSION_DIRS" ]; then
            echo "No submission bundles found"
            echo "submission_dirs=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Convert to JSON array for GitHub Actions
          JSON_ARRAY=$(echo "$SUBMISSION_DIRS" | jq -R -s 'split("\n") | map(select(. != ""))')
          echo "submission_dirs=$JSON_ARRAY" >> $GITHUB_OUTPUT
          echo "Found submission bundles: $SUBMISSION_DIRS"

      - name: Run submission validation
        id: validate
        run: |
          set -euo pipefail
          ./scripts/validate-submission.sh Contrib/submissions/* > /tmp/validation.txt
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/validation.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT


      - name: Add labels
        if: always()
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: |
            device-submission

      - name: Post validation summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const body = "### Submission validation\n```\n" + process.env['SUMMARY'] + "\n```";
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
        env:
          SUMMARY: ${{ steps.validate.outputs.summary }}

      - name: Check privacy (no salts, no PII)
        run: |
          set -euo pipefail
          # salts are forbidden
          if git ls-files | grep -E '\.salt$' ; then
            echo "::error::Found forbidden .salt files in PR"; exit 1
          fi
          # sanity: no obvious usernames/paths in artifacts
          if grep -R -nE '/Users/[^/ ]+|C:\\\\Users\\\\[^\\\\ ]+|\\\\home\\\\[^\\\\ ]+' Contrib/submissions/ ; then
            echo "::error::Detected local user paths in submission"; exit 1
          fi

