name: ci
on:
  push:
  pull_request:
jobs:
  build-test:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Select Xcode 16
        uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: "16" }
      - name: Swift version
        run: swift --version
      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
      - name: Build (SwiftMTPKit)
        working-directory: SwiftMTPKit
        run: swift build -v
      - name: Unit Tests (Core, Index, Transport)
        working-directory: SwiftMTPKit
        run: swift test -v --enable-code-coverage --filter CoreTests --filter IndexTests --filter TransportTests
      - name: BDD Tests
        working-directory: SwiftMTPKit
        run: swift test -v --filter BDDTests
      - name: Property Tests (SwiftCheck + Fuzz)
        working-directory: SwiftMTPKit
        run: swift test -v --filter PropertyTests
      - name: Snapshot Tests
        working-directory: SwiftMTPKit
        run: swift test -v --filter SnapshotTests
      - name: TestKit Tests
        working-directory: SwiftMTPKit
        run: swift test -v --filter TestKitTests
      - name: Scenario Tests
        working-directory: SwiftMTPKit
        run: swift test -v --filter ScenarioTests
      - name: Code Coverage Report
        working-directory: SwiftMTPKit
        run: |
          swift package generate-code-coverage-path-for-reports
          # Upload coverage if needed
      - name: Swift format (lint)
        run: brew install swift-format && swift-format lint -r . --strict

  tsan:
    runs-on: macos-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: "16" }
      - name: TSAN (Core/Index/Scenario only)
        working-directory: SwiftMTPKit
        run: swift test -Xswiftc -sanitize=thread --filter CoreTests --filter IndexTests --filter ScenarioTests

  fuzz-test:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: "16" }
      - name: Build Fuzzer
        working-directory: SwiftMTPKit
        run: swift build --product SwiftMTPFuzz 2>/dev/null || echo "No fuzzer product, skipping"
      - name: Run Quick Fuzz Test
        working-directory: SwiftMTPKit
        run: |
          if [ -f "run-fuzz.sh" ]; then
            head -c 100 /dev/urandom > fuzz_input.bin
            ./run-fuzz.sh fuzz_input.bin || echo "Fuzz test completed"
          fi

  sbom:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate SBOM (SPDX)
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: spdx-json
          output-file: sbom.spdx.json
      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.spdx.json
