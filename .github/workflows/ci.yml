name: ci
# Purpose: Primary CI â€” runs on every push and PR (all branches).
# Checks: build, UX validation, full test suite + coverage, TSAN (thread sanitizer),
#         fuzz harness, SBOM (on tags). This is the required check for merging PRs.
# Complement: swiftmtp-ci.yml adds deeper coverage reporting, docs, and CLI smoke on main.
on:
  push:
  pull_request:
jobs:
  build-test:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Select Xcode 16
        uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: "16.2" }
      - name: Swift version
        run: swift --version
      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
      - name: Build (SwiftMTPKit)
        working-directory: SwiftMTPKit
        run: swift build -v
      - name: Validate UX touch policy
        run: ./scripts/validate-ux-touch.sh
      - name: Ensure UX map schema tooling
        run: python3 -m pip install --break-system-packages jsonschema
      - name: Validate UX interaction map
        run: ./scripts/validate-ux-map.sh
      - name: Critical UX UI lane (mock deterministic)
        continue-on-error: true
        env:
          SWIFTMTP_UI_TEST_ARTIFACT_BASE_DIR: ${{ github.workspace }}/artifacts/ui
        run: |
          mkdir -p artifacts/ui
          xcodebuild -project SwiftMTP.xcodeproj -resolvePackageDependencies || true
          xcodebuild test \
            -project SwiftMTP.xcodeproj \
            -scheme SwiftMTP \
            -destination 'platform=macOS' \
            -only-testing:SwiftMTPUITests/CriticalFlowTests \
            -resultBundlePath artifacts/ui/critical-flows.xcresult
      - name: Upload critical UI artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: critical-ui-artifacts
          retention-days: 14
          path: |
            artifacts/ui/critical-flows.xcresult
            artifacts/ui
      - name: Full Test Suite + Coverage Gate + Xcode Unit/UI Tests
        env:
          RUN_XCODE_UI_TESTS: "1"
        run: ./run-all-tests.sh
      - name: Swift format (lint)
        run: brew install swift-format && swift-format lint -r . --strict

  tsan:
    runs-on: macos-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: "16.2" }
      - name: TSAN (Core/Index/Scenario only)
        working-directory: SwiftMTPKit
        run: swift test -Xswiftc -sanitize=thread --filter CoreTests --filter IndexTests --filter ScenarioTests

  fuzz-test:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: "16.2" }
      - name: Build Fuzzer
        working-directory: SwiftMTPKit
        run: swift build --product SwiftMTPFuzz 2>/dev/null || echo "No fuzzer product, skipping"
      - name: Run Quick Fuzz Test
        working-directory: SwiftMTPKit
        run: |
          if [ -f "run-fuzz.sh" ]; then
            head -c 100 /dev/urandom > fuzz_input.bin
            ./run-fuzz.sh fuzz_input.bin || echo "Fuzz test completed"
          fi

  sbom:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate SBOM (SPDX)
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: spdx-json
          output-file: sbom.spdx.json
      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.spdx.json
