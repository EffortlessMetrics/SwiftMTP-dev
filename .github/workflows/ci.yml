name: ci
# Purpose: Primary CI â€” runs on every push and PR (all branches).
# Checks: build, UX validation, full test suite + coverage, TSAN (thread sanitizer),
#         fuzz harness, SBOM (on tags). This is the required check for merging PRs.
# Complement: swiftmtp-ci.yml adds deeper coverage reporting, docs, and CLI smoke on main.
on:
  push:
  pull_request:
jobs:
  build-test:
    # Pin to macos-15 to avoid DTXConnectionServices interceptor crashes
    # that occur on macos-latest runners (signal 5 / DTXBlockCompressorLibCompression).
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Select Xcode 16
        uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: "16.2" }
      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.2'
      - name: Swift version
        run: swift --version
      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
      - name: Build (SwiftMTPKit)
        working-directory: SwiftMTPKit
        run: swift build -v
      - name: Validate UX touch policy
        run: ./scripts/validate-ux-touch.sh
      - name: Ensure UX map schema tooling
        run: python3 -m pip install --break-system-packages jsonschema
      - name: Validate UX interaction map
        run: ./scripts/validate-ux-map.sh
      - name: Critical UX UI lane (mock deterministic)
        continue-on-error: true
        env:
          SWIFTMTP_UI_TEST_ARTIFACT_BASE_DIR: ${{ github.workspace }}/artifacts/ui
        run: |
          mkdir -p artifacts/ui
          xcodebuild -project SwiftMTP.xcodeproj -resolvePackageDependencies || true
          xcodebuild test \
            -project SwiftMTP.xcodeproj \
            -scheme SwiftMTP \
            -destination 'platform=macOS' \
            -only-testing:SwiftMTPUITests/CriticalFlowTests \
            -resultBundlePath artifacts/ui/critical-flows.xcresult
      - name: Upload critical UI artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: critical-ui-artifacts
          retention-days: 14
          path: |
            artifacts/ui/critical-flows.xcresult
            artifacts/ui
      - name: Full Test Suite + Coverage Gate + Xcode Unit/UI Tests
        env:
          RUN_XCODE_UI_TESTS: "1"
        run: ./run-all-tests.sh
      - name: Swift format (lint)
        run: brew install swift-format && swift-format lint -r . --strict

  tsan:
    # Pin to macos-15 to avoid DTXConnectionServices interceptor conflicts
    # that cause TSAN to crash on macos-latest runners. Matches tsan-and-compat.yml.
    runs-on: macos-15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: "16.2" }

      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.2'

      - name: Resolve TSAN runtime dylib
        id: tsan_rt
        shell: bash
        run: |
          set -euo pipefail
          # Resolve symlinks so we get the real toolchain path
          # (setup-swift may place a symlink in PATH)
          SWIFT_BIN="$(command -v swift)"
          SWIFT_REAL="$(python3 -c "import os,sys; sys.stdout.write(os.path.realpath('$SWIFT_BIN'))")"
          TOOLCHAIN_USR="$(cd "$(dirname "$SWIFT_REAL")/.." && pwd)"

          TSAN_DYLIB="$(find "$TOOLCHAIN_USR/lib/clang" -name libclang_rt.tsan_osx_dynamic.dylib -print -quit 2>/dev/null || true)"

          # Fallback: search the hostedtoolcache Swift installation
          if [ -z "$TSAN_DYLIB" ]; then
            TSAN_DYLIB="$(find /Users/runner/hostedtoolcache/swift-macOS -name libclang_rt.tsan_osx_dynamic.dylib -print -quit 2>/dev/null || true)"
          fi

          # Fallback: search selected Xcode toolchain
          if [ -z "$TSAN_DYLIB" ]; then
            XCODE_TC="$(xcode-select -p)/Toolchains/XcodeDefault.xctoolchain/usr"
            TSAN_DYLIB="$(find "$XCODE_TC/lib/clang" -name libclang_rt.tsan_osx_dynamic.dylib -print -quit 2>/dev/null || true)"
          fi

          if [ -z "$TSAN_DYLIB" ]; then
            echo "::error::Could not locate libclang_rt.tsan_osx_dynamic.dylib"
            exit 1
          fi

          TSAN_DIR="$(dirname "$TSAN_DYLIB")"
          echo "tsan_dylib=$TSAN_DYLIB" >> "$GITHUB_OUTPUT"
          echo "tsan_dir=$TSAN_DIR" >> "$GITHUB_OUTPUT"
          echo "Found TSAN runtime: $TSAN_DYLIB"
          ls -la "$TSAN_DYLIB"

      - name: Build tests (TSAN)
        working-directory: SwiftMTPKit
        run: swift build --build-tests -Xswiftc -sanitize=thread

      - name: TSAN (Core/Index/Scenario only)
        working-directory: SwiftMTPKit
        run: |
          # Inline DYLD_INSERT_LIBRARIES to avoid SIP stripping the env
          # var when swift-test spawns xctest through a system binary path.
          # -Xlinker -rpath ensures the dynamic linker can resolve the runtime.
          DYLD_INSERT_LIBRARIES="${{ steps.tsan_rt.outputs.tsan_dylib }}" \
          swift test \
            --skip-build \
            -Xswiftc -sanitize=thread \
            -Xlinker -rpath -Xlinker "${{ steps.tsan_rt.outputs.tsan_dir }}" \
            --filter CoreTests --filter IndexTests --filter ScenarioTests

  fuzz-test:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: "16.2" }
      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.2'
      - name: Build Fuzzer
        working-directory: SwiftMTPKit
        run: swift build --product SwiftMTPFuzz 2>/dev/null || echo "No fuzzer product, skipping"
      - name: Run Quick Fuzz Test
        working-directory: SwiftMTPKit
        run: |
          if [ -f "run-fuzz.sh" ]; then
            head -c 100 /dev/urandom > fuzz_input.bin
            ./run-fuzz.sh fuzz_input.bin || echo "Fuzz test completed"
          fi

  sbom:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate SBOM (SPDX)
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: spdx-json
          output-file: sbom.spdx.json
      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.spdx.json
