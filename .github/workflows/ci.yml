name: ci
on:
  push:
  pull_request:
jobs:
  build-test:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Select Xcode 16
        uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: "16" }
      - name: Swift version
        run: swift --version
      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
      - name: Build (SwiftMTPKit)
        working-directory: SwiftMTPKit
        run: swift build -v
      - name: Test (SwiftMTPKit)
        working-directory: SwiftMTPKit
        run: swift test -v --enable-code-coverage --skip "*BDD*" --skip "*Feature*"
      - name: Swift format (lint)
        run: brew install swift-format && swift-format lint -r . --strict

  tsan:
    runs-on: macos-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: "16" }
      - name: TSAN (Core/Index/Scenario only)
        working-directory: SwiftMTPKit
        run: swift test -Xswiftc -sanitize=thread --filter CoreTests --filter IndexTests --filter ScenarioTests

  sbom:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate SBOM (SPDX)
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: spdx-json
          output-file: sbom.spdx.json
      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.spdx.json
