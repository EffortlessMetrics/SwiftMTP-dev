name: release
on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Version tag (v1.0.0)'
        required: true
jobs:
  cut:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - run: ./scripts/build-libusb-xcframework.sh
      - run: ./scripts/prepare-release.sh
      - name: Commit XCFramework and tag
        run: |
          git config user.name "ci"
          git config user.email "ci@example.com"
          git add ThirdParty/CLibusb.xcframework SwiftMTPKit/Package.swift
          git commit -m "chore(release): bundle libusb XCFramework"
          git tag ${{ inputs.tag }}
          git push --follow-tags
      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          { path: ., format: spdx-json, output-file: sbom.spdx.json }
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag }}
          files: |
            sbom.spdx.json
