name: Release
on:
  push:
    tags:
      - "v*"

jobs:
  build-macos:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - name: Build
        run: swift build -c release --package-path SwiftMTPKit --product swiftmtp
      - name: Package
        run: |
          BIN="$(swift build -c release --package-path SwiftMTPKit --product swiftmtp --show-bin-path)/swiftmtp"
          mkdir -p dist/${GITHUB_REF_NAME}
          tar -C "$(dirname "$BIN")" -czf dist/${GITHUB_REF_NAME}/swiftmtp-macos-arm64.tar.gz swiftmtp
          shasum -a 256 dist/${GITHUB_REF_NAME}/swiftmtp-macos-arm64.tar.gz > dist/${GITHUB_REF_NAME}/swiftmtp-macos-arm64.tar.gz.sha256
      - name: Create draft release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: |
            dist/${{ github.ref_name }}/swiftmtp-macos-arm64.tar.gz
            dist/${{ github.ref_name }}/swiftmtp-macos-arm64.tar.gz.sha256

  # Optional: add a linux job building and attaching a linux artifact