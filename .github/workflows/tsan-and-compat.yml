# SPDX-License-Identifier: AGPL-3.0-only
# Copyright (c) 2025 Effortless Metrics, Inc.

name: TSAN and Compat Matrix
# Purpose: Thread-sanitizer run on key test suites, compatibility matrix validation,
#          and SPDX license-header check on all Swift sources.
# Runs on: push to main/feat/**, and PRs targeting main.
# Complement: ci.yml runs TSAN on all branches; this adds compat-matrix and license gating.

on:
  push:
    branches:
      - main
      - 'feat/**'
  pull_request:
    branches:
      - main

jobs:
  tsan:
    name: Thread Sanitizer (Core / Index / Scenario)
    runs-on: macos-15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: "16.2" }

      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.2'

      - name: Resolve TSAN runtime dylib
        id: tsan_rt
        shell: bash
        run: |
          set -euo pipefail
          # Resolve symlinks so we get the real toolchain path
          # (setup-swift may place a symlink in PATH)
          SWIFT_BIN="$(command -v swift)"
          SWIFT_REAL="$(python3 -c "import os,sys; sys.stdout.write(os.path.realpath('$SWIFT_BIN'))")"
          TOOLCHAIN_USR="$(cd "$(dirname "$SWIFT_REAL")/.." && pwd)"

          TSAN_DYLIB="$(find "$TOOLCHAIN_USR/lib/clang" -name libclang_rt.tsan_osx_dynamic.dylib -print -quit 2>/dev/null || true)"

          # Fallback: search the hostedtoolcache Swift installation
          if [ -z "$TSAN_DYLIB" ]; then
            TSAN_DYLIB="$(find /Users/runner/hostedtoolcache/swift-macOS -name libclang_rt.tsan_osx_dynamic.dylib -print -quit 2>/dev/null || true)"
          fi

          # Fallback: search selected Xcode toolchain
          if [ -z "$TSAN_DYLIB" ]; then
            XCODE_TC="$(xcode-select -p)/Toolchains/XcodeDefault.xctoolchain/usr"
            TSAN_DYLIB="$(find "$XCODE_TC/lib/clang" -name libclang_rt.tsan_osx_dynamic.dylib -print -quit 2>/dev/null || true)"
          fi

          if [ -z "$TSAN_DYLIB" ]; then
            echo "::error::Could not locate libclang_rt.tsan_osx_dynamic.dylib"
            exit 1
          fi

          TSAN_DIR="$(dirname "$TSAN_DYLIB")"
          echo "tsan_dylib=$TSAN_DYLIB" >> "$GITHUB_OUTPUT"
          echo "tsan_dir=$TSAN_DIR" >> "$GITHUB_OUTPUT"
          echo "Found TSAN runtime: $TSAN_DYLIB"
          ls -la "$TSAN_DYLIB"

      - name: Build tests (TSAN)
        working-directory: SwiftMTPKit
        run: swift build --build-tests -Xswiftc -sanitize=thread

      - name: TSAN â€“ CoreTests / IndexTests / ScenarioTests
        working-directory: SwiftMTPKit
        run: |
          # Inline DYLD_INSERT_LIBRARIES to avoid SIP stripping the env
          # var when swift-test spawns xctest through a system binary path.
          # -Xlinker -rpath ensures the dynamic linker can resolve the runtime.
          DYLD_INSERT_LIBRARIES="${{ steps.tsan_rt.outputs.tsan_dylib }}" \
          swift test \
            --skip-build \
            -Xswiftc -sanitize=thread \
            -Xlinker -rpath -Xlinker "${{ steps.tsan_rt.outputs.tsan_dir }}" \
            --filter CoreTests --filter IndexTests --filter ScenarioTests

  compat-matrix:
    name: Compatibility Matrix
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate compat harness is importable
        run: python3 scripts/compat-harness.py --help

      - name: Validate compat matrix script
        run: bash scripts/generate-compat-matrix.sh

  license-check:
    name: SPDX License Header Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check all Swift sources have SPDX header
        run: |
          find SwiftMTPKit/Sources -name "*.swift" | while read f; do
            head -1 "$f" | grep -q "SPDX-License-Identifier" || (echo "Missing SPDX in $f" && exit 1)
          done
