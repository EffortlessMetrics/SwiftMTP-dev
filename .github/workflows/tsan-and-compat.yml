# SPDX-License-Identifier: AGPL-3.0-only
# Copyright (c) 2025 Effortless Metrics, Inc.

name: TSAN and Compat Matrix
# Purpose: Thread-sanitizer run on key test suites, compatibility matrix validation,
#          and SPDX license-header check on all Swift sources.
# Runs on: push to main/feat/**, and PRs targeting main.
# Complement: ci.yml runs TSAN on all branches; this adds compat-matrix and license gating.

on:
  push:
    branches:
      - main
      - 'feat/**'
  pull_request:
    branches:
      - main

jobs:
  tsan:
    name: Thread Sanitizer (Core / Index / Scenario)
    runs-on: macos-15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: "16.2" }

      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.2'

      - name: Resolve TSAN runtime dylib
        id: tsan_rt
        shell: bash
        run: |
          set -euo pipefail
          SWIFT_BIN="$(command -v swift)"
          TOOLCHAIN_USR="$(cd "$(dirname "$SWIFT_BIN")/.." && pwd)"
          TSAN_DYLIB="$(find "$TOOLCHAIN_USR/lib/clang" -name libclang_rt.tsan_osx_dynamic.dylib -print -quit)"
          test -n "$TSAN_DYLIB"
          echo "tsan_dylib=$TSAN_DYLIB" >> "$GITHUB_OUTPUT"
          ls -la "$TSAN_DYLIB"

      - name: TSAN â€“ CoreTests / IndexTests / ScenarioTests
        working-directory: SwiftMTPKit
        env:
          DYLD_INSERT_LIBRARIES: ${{ steps.tsan_rt.outputs.tsan_dylib }}
        run: swift test -Xswiftc -sanitize=thread --filter CoreTests --filter IndexTests --filter ScenarioTests

  compat-matrix:
    name: Compatibility Matrix
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate compat harness is importable
        run: python3 scripts/compat-harness.py --help

      - name: Validate compat matrix script
        run: bash scripts/generate-compat-matrix.sh

  license-check:
    name: SPDX License Header Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check all Swift sources have SPDX header
        run: |
          find SwiftMTPKit/Sources -name "*.swift" | while read f; do
            head -1 "$f" | grep -q "SPDX-License-Identifier" || (echo "Missing SPDX in $f" && exit 1)
          done
