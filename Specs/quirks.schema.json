{
  "$id": "https://effortlessmetrics.dev/swiftmtp/quirks.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "SwiftMTP Device Quirks",
  "type": "object",
  "required": ["schemaVersion", "version", "entries"],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Reference to this schema file"
    },
    "schemaVersion": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Semantic version of the schema format"
    },
    "version": {
      "type": "integer",
      "minimum": 1,
      "description": "Data version for forward compatibility"
    },
    "entries": {
      "type": "array",
      "description": "Array of device quirk entries",
      "items": { "$ref": "#/$defs/quirkEntry" }
    }
  },
  "additionalProperties": false,

  "$defs": {
    "hexVidPid": {
      "type": "string",
      "pattern": "^0x[0-9a-fA-F]{4}$"
    },
    "hexByte": {
      "type": "string",
      "pattern": "^0x[0-9a-fA-F]{2}$"
    },
    "statusEnum": {
      "type": "string",
      "enum": ["stable", "experimental", "proposed", "blocked", "promoted", "verified"]
    },
    "confidenceEnum": {
      "type": "string",
      "enum": ["high", "medium", "low"]
    },

    "quirkEntry": {
      "type": "object",
      "required": ["id", "match", "status"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z0-9-]+$",
          "minLength": 1,
          "description": "Unique kebab-case identifier for this quirk entry"
        },
        "match": { "$ref": "#/$defs/matchBlock" },
        "tuning": { "$ref": "#/$defs/tuningBlock" },
        "hooks": {
          "type": "array",
          "items": { "$ref": "#/$defs/hookEntry" }
        },
        "ops": {
          "type": "object",
          "description": "Operation capability flags — all values must be boolean",
          "additionalProperties": { "type": "boolean" }
        },
        "flags": {
          "type": "object",
          "description": "Device behavior flags — all values must be boolean (except preferredWriteFolder)",
          "properties": {
            "preferredWriteFolder": {
              "type": "string",
              "description": "Preferred folder name for writes when writeToSubfolderOnly is true"
            }
          },
          "additionalProperties": { "type": "boolean" }
        },
        "probeLadder": {
          "type": "object",
          "description": "Multi-step probe configuration"
        },
        "behaviorLimitations": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "operation": { "type": "string" },
              "errorCode": { "type": "string" },
              "description": { "type": "string" },
              "workaround": { "type": "string" }
            }
          }
        },
        "evidenceRequired": {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of evidence types needed for promotion"
        },
        "confidence": { "$ref": "#/$defs/confidenceEnum" },
        "status": { "$ref": "#/$defs/statusEnum" },
        "governance": {
          "type": "object",
          "properties": {
            "status": { "$ref": "#/$defs/statusEnum" },
            "evidenceRequired": { "type": "string" },
            "addedBy": { "type": "string" },
            "addedDate": { "type": "string", "format": "date" },
            "verificationNotes": { "type": "string" }
          }
        },
        "notes": {
          "type": "array",
          "items": { "type": "string" }
        },
        "provenance": {
          "type": "object",
          "properties": {
            "author": { "type": "string" },
            "date": { "type": "string", "format": "date" },
            "commit": { "type": "string" },
            "artifacts": { "type": "object" }
          }
        },
        "benchGates": {
          "type": "object",
          "properties": {
            "readMBpsMin": { "type": "number", "minimum": 0 },
            "writeMBpsMin": { "type": "number", "minimum": 0 }
          }
        },
        "lastVerifiedDate": { "type": "string", "format": "date" },
        "lastVerifiedBy": { "type": "string" }
      }
    },

    "matchBlock": {
      "type": "object",
      "required": ["vid", "pid"],
      "properties": {
        "vid": { "$ref": "#/$defs/hexVidPid", "description": "USB Vendor ID (hex)" },
        "pid": { "$ref": "#/$defs/hexVidPid", "description": "USB Product ID (hex)" },
        "deviceInfoRegex": { "type": "string" },
        "iface": {
          "type": "object",
          "properties": {
            "class": { "$ref": "#/$defs/hexByte" },
            "subclass": { "$ref": "#/$defs/hexByte" },
            "protocol": { "$ref": "#/$defs/hexByte" }
          }
        },
        "endpoints": {
          "type": "object",
          "properties": {
            "in": { "$ref": "#/$defs/hexByte" },
            "out": { "$ref": "#/$defs/hexByte" },
            "evt": { "$ref": "#/$defs/hexByte" }
          }
        }
      }
    },

    "tuningBlock": {
      "type": "object",
      "required": ["maxChunkBytes", "handshakeTimeoutMs", "ioTimeoutMs", "inactivityTimeoutMs", "overallDeadlineMs"],
      "properties": {
        "maxChunkBytes": { "type": "integer", "minimum": 131072, "maximum": 16777216 },
        "handshakeTimeoutMs": { "type": "integer", "minimum": 1000, "maximum": 60000 },
        "ioTimeoutMs": { "type": "integer", "minimum": 1000, "maximum": 60000 },
        "inactivityTimeoutMs": { "type": "integer", "minimum": 1000, "maximum": 60000 },
        "overallDeadlineMs": { "type": "integer", "minimum": 30000, "maximum": 600000 },
        "stabilizeMs": { "type": "integer", "minimum": 0, "maximum": 2000 },
        "eventPumpDelayMs": { "type": "integer", "minimum": 0, "maximum": 5000 },
        "resetOnOpen": { "type": "boolean" },
        "requiresKernelDetach": { "type": "boolean" },
        "alternateInterfaceSelection": { "type": "boolean" },
        "postClaimStabilizeMs": { "type": "integer", "minimum": 0, "maximum": 5000 }
      }
    },

    "hookEntry": {
      "type": "object",
      "required": ["phase"],
      "properties": {
        "phase": {
          "type": "string",
          "enum": [
            "postOpenUSB", "postClaimInterface", "postOpenSession",
            "beforeGetDeviceInfo", "beforeGetStorageIDs", "beforeGetObjectHandles",
            "beforeTransfer", "afterTransfer", "onDeviceBusy", "onDetach"
          ]
        },
        "delayMs": { "type": "integer", "minimum": 0, "maximum": 5000 },
        "busyBackoff": {
          "type": "object",
          "properties": {
            "retries": { "type": "integer", "minimum": 0, "maximum": 10 },
            "baseMs": { "type": "integer", "minimum": 100, "maximum": 5000 },
            "jitterPct": { "type": "number", "minimum": 0.0, "maximum": 1.0 }
          }
        }
      }
    }
  }
}
